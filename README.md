# 校园活动报名与签到管理系统

## 项目概述

这是一个基于Qt框架开发的校园活动报名与签到管理系统，实现了多角色登录、活动发布与审批、学生在线报名/取消、报名冲突检测、候补排队等功能。

## 技术栈

- **框架**: Qt 5/6 (C++)
- **数据库**: SQLite
- **架构**: MVC (Model/View/Controller)
- **模块**: GUI + MV + DB + NET + THR + FILE

## 功能模块

### 1. 用户角色管理
- **管理员 (Admin)**: 可以审批活动、查看所有活动、导出统计报表
- **发起人 (Organizer)**: 可以发布活动、查看自己发布的活动、查看报名列表
- **学生 (Student)**: 可以浏览已批准的活动、报名/取消报名、查看自己的报名记录

### 2. 活动管理
- 活动发布（发起人）
- 活动审批（管理员）
- 活动查看和搜索
- 活动状态管理（待审批、已批准、已拒绝、进行中、已结束）

### 3. 报名管理
- 在线报名
- 取消报名
- 时间冲突检测
- 候补排队机制
- 报名列表查看
- 签到功能（新增）
- 签到列表查看（新增）
- 签到统计（新增）

### 4. 数据库管理
- SQLite数据库存储
- 用户表、活动表、报名表、候补表
- 数据完整性约束和索引优化

### 5. 后台线程
- 冲突检查线程（ConflictChecker）
- 多线程报表导出（ExportThread，新增）
  - 后台执行CSV文件写入
  - 显示导出进度
  - 避免UI阻塞

### 6. 网络功能
- 从服务器获取活动类别
- 从服务器获取公告信息
- 同步活动信息到校园平台（新增）
  - 活动批准后自动同步
  - 支持同步结果反馈

### 7. 文件导出
- CSV格式导出报名名单
- CSV格式导出统计报表

## 数据库设计

### 用户表 (users)
- id: 主键
- username: 用户名（唯一）
- password: 密码（SHA256哈希）
- role: 角色（0=管理员, 1=发起人, 2=学生）
- name: 姓名
- created_at: 创建时间

### 活动表 (activities)
- id: 主键
- title: 活动标题
- description: 活动描述
- category: 活动类别
- organizer: 发起人
- start_time: 开始时间
- end_time: 结束时间
- max_participants: 最大参与人数
- current_participants: 当前参与人数
- location: 地点
- status: 状态（0=待审批, 1=已批准, 2=已拒绝, 3=进行中, 4=已结束）
- created_at: 创建时间
- approved_at: 批准时间
- approved_by: 批准人

### 报名表 (registrations)
- id: 主键
- activity_id: 活动ID（外键）
- student_id: 学号
- student_name: 学生姓名
- status: 报名状态（0=已报名, 1=已取消, 2=候补, 3=已确认）
- registered_at: 报名时间
- checkin_time: 签到时间（新增，可为空）

### 候补表 (waitlist)
- id: 主键
- activity_id: 活动ID（外键）
- student_id: 学号
- student_name: 学生姓名
- added_at: 加入候补时间

## 编译和运行

### 环境要求
- Qt 5.12 或更高版本
- C++11 或更高版本
- CMake 或 qmake

### 编译步骤

1. 打开Qt Creator
2. 打开项目文件 `exp_PesernoalWork.pro`
3. 配置构建套件（Kit）
4. 点击"构建"按钮编译项目
5. 运行程序

### 或者使用命令行

```bash
qmake exp_PesernoalWork.pro
make  # 在Windows上使用 nmake 或 mingw32-make
```

## 使用说明

### 首次运行

1. 程序启动后会自动创建SQLite数据库文件 `activity_management.db`
2. 系统会自动创建默认管理员账户：
   - 用户名: `admin`
   - 密码: `admin123`
   - 角色: 管理员

### 登录系统

1. 选择角色（管理员/发起人/学生）
2. 输入用户名和密码
3. 点击"登录"按钮

### 注册新用户

1. 在登录界面选择角色（学生或发起人）
2. 输入用户名和密码
3. 点击"注册"按钮
4. 输入姓名完成注册

### 发布活动（发起人）

1. 登录为发起人角色
2. 进入"活动管理"标签页
3. 点击"发布活动"按钮
4. 填写活动信息：
   - 标题（必填）
   - 描述
   - 类别（必填）
   - 开始时间
   - 结束时间
   - 最大人数
   - 地点
5. 点击"确定"提交
6. 活动将进入"待审批"状态

### 审批活动（管理员）

1. 登录为管理员角色
2. 进入"活动管理"标签页
3. 选择待审批的活动
4. 点击"批准"或"拒绝"按钮

### 报名活动（学生）

1. 登录为学生角色
2. 首次登录需要输入学号和姓名
3. 进入"活动管理"标签页查看已批准的活动
4. 记录想要报名的活动ID
5. 进入"报名管理"标签页
6. 点击"报名活动"按钮
7. 输入活动ID
8. 系统会自动检测时间冲突
9. 如果有冲突，可以选择是否继续报名
10. 报名成功后会显示在报名列表中

### 取消报名（学生）

1. 在"报名管理"标签页中选择要取消的报名
2. 点击"取消报名"按钮
3. 确认取消

### 查看候补列表（发起人/管理员）

1. 在"报名管理"标签页中选择活动
2. 点击"查看候补"按钮
3. 查看候补学生列表

### 导出报名名单（发起人/管理员）

1. 在"报名管理"标签页中选择活动
2. 点击"导出CSV"按钮
3. 选择保存位置
4. 导出成功

### 导出统计报表（管理员）

1. 登录为管理员
2. 点击菜单"文件" -> "导出统计报表"
3. 选择保存位置
4. 系统会在后台线程中导出所有活动的统计信息
5. 导出过程中会显示进度
6. 导出完成后会显示结果提示

**注意：** 导出使用多线程技术，不会阻塞UI界面。

### 签到功能（新增）

#### 学生签到
1. 登录为学生角色
2. 进入"报名管理"标签页
3. 在"我的报名"标签中选择已报名的活动
4. 点击"签到"按钮
5. 系统会检查活动是否已开始
6. 签到成功后会记录签到时间

#### 管理员/发起人为学生签到
1. 登录为管理员或发起人
2. 进入"报名管理"标签页
3. 选择活动
4. 点击"签到管理"按钮
5. 输入学生学号
6. 系统会为学生执行签到

#### 查看签到列表
1. 在"报名管理"标签页中选择活动
2. 点击"查看签到列表"按钮
3. 查看该活动的所有签到记录

#### 查看签到统计
1. 在"报名管理"标签页中选择活动
2. 点击"签到统计"按钮
3. 查看该活动的签到统计信息，包括：
   - 最大人数
   - 已报名人数
   - 已签到人数
   - 未签到人数
   - 签到率

### 获取活动类别（网络功能）

1. 点击菜单"网络" -> "获取活动类别"
2. 系统会尝试从服务器获取活动类别列表
3. 如果网络请求失败，会使用默认类别列表

### 获取公告（网络功能）

1. 点击菜单"网络" -> "获取公告"
2. 系统会尝试从服务器获取公告信息
3. 显示公告列表

### 活动同步到校园平台（网络功能，新增）

1. 管理员批准活动后，系统会自动尝试同步到校园平台
2. 同步成功或失败会显示相应提示
3. 同步失败不影响活动的正常使用

## 网络服务器配置

系统默认尝试连接 `http://localhost:8080/api` 获取活动类别和公告。

### 服务器API接口

#### 获取活动类别
- URL: `GET /api/categories`
- 响应格式: JSON数组
```json
[
  {"name": "学术讲座"},
  {"name": "文体活动"},
  ...
]
```

#### 获取公告
- URL: `GET /api/announcements`
- 响应格式: JSON数组
```json
[
  {
    "title": "公告标题",
    "content": "公告内容",
    "date": "2024-01-01"
  },
  ...
]
```

#### 同步活动信息（新增）
- URL: `POST /api/activities/sync`
- 请求格式: JSON
```json
{
  "id": 1,
  "title": "活动标题",
  "description": "活动描述",
  "category": "活动类别",
  "organizer": "发起人",
  "start_time": "2024-01-01T10:00:00",
  "end_time": "2024-01-01T12:00:00",
  "max_participants": 100,
  "location": "活动地点",
  "status": 1
}
```
- 响应格式: JSON
```json
{
  "success": true,
  "message": "同步成功"
}
```

### 修改服务器地址

在 `networkmanager.cpp` 中修改 `baseUrl` 变量：
```cpp
QString baseUrl = "http://your-server-address:port/api";
```

## 文件结构

```
exp_PesernoalWork/
├── exp_PesernoalWork.pro      # Qt项目文件
├── main.cpp                    # 程序入口
├── mainwindow.h/cpp            # 主窗口
├── database.h/cpp              # 数据库管理类
├── loginwindow.h/cpp/ui        # 登录窗口
├── activitymanager.h/cpp       # 活动管理模块
├── registrationmanager.h/cpp  # 报名管理模块
├── conflictchecker.h/cpp      # 冲突检查线程
├── networkmanager.h/cpp        # 网络管理类
├── csvexporter.h/cpp          # CSV导出类
├── exportthread.h/cpp          # 多线程导出类（新增）
└── README.md                  # 本文件
```

## 注意事项

1. **数据库文件**: 数据库文件 `activity_management.db` 会在程序首次运行时自动创建在当前目录
2. **密码安全**: 用户密码使用SHA256哈希存储，不会明文保存
3. **时间冲突检测**: 系统会自动检测学生报名活动的时间冲突，但允许学生选择是否继续报名
4. **候补机制**: 当活动报名人数已满时，新报名的学生会自动加入候补列表；当有学生取消报名时，候补列表中的第一个学生会自动提升为正式报名
5. **签到功能**: 活动开始后，学生可以对自己已报名的活动进行签到；管理员/发起人也可以为学生签到；系统会记录签到时间并支持签到统计
6. **多线程导出**: 导出统计报表时使用后台线程，避免UI阻塞，并提供进度反馈
7. **网络功能**: 如果服务器不可用，网络功能会使用默认数据或显示错误信息，不影响其他功能的使用；活动批准后会自动尝试同步到校园平台

## 开发说明

### 添加新功能

1. 在相应的模块类中添加新方法
2. 在UI中添加相应的按钮或控件
3. 连接信号和槽
4. 更新数据库结构（如需要）

### 数据库迁移

如果需要修改数据库结构：
1. 在 `database.cpp` 的 `createTables()` 方法中修改表结构
2. 对于已有数据库，系统会自动检测并添加新字段（如签到时间字段）
3. 如果需要删除字段或修改字段类型，需要编写迁移脚本或删除旧数据库文件

### 签到功能说明

系统已实现完整的签到功能：
- **签到条件**: 学生必须已报名该活动，且活动已开始
- **签到方式**: 
  - 学生可以在"报名管理" -> "我的报名"中对自己已报名的活动进行签到
  - 管理员/发起人可以在"报名管理"中为学生签到
- **签到记录**: 系统会记录签到时间，支持查看签到列表和统计
- **防重复签到**: 每个活动每个学生只能签到一次

## 许可证

本项目为实验项目，仅供学习使用。

## 作者

实验项目 - 校园活动报名与签到管理系统

