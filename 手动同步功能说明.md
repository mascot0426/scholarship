# 手动同步功能说明

## 功能概述

当数据库中的活动记录被删除后，如果需要重新同步这些活动到校园平台，可以使用**手动同步**功能。

## 使用场景

1. **数据库删除后恢复同步**：本地数据库中的活动被删除，但服务器上仍有记录，需要重新同步
2. **同步失败后重试**：自动同步失败，需要手动重新同步
3. **批量同步**：需要同步多个已批准的活动

## 使用方法

### 方法1：通过界面手动同步

1. **打开活动管理界面**
   - 以管理员（Admin）或发起人（Organizer）身份登录
   - 进入活动管理页面

2. **选择要同步的活动**
   - 在活动列表中选择一个已批准的活动（状态为"已批准"）
   - 点击"手动同步"按钮

3. **确认同步**
   - 系统会弹出确认对话框
   - 点击"是"确认同步

4. **查看同步结果**
   - 同步成功：显示"活动已成功同步到校园平台！"
   - 同步失败：显示"活动同步到校园平台失败，请检查网络连接！"

### 方法2：通过API直接同步（适用于数据库删除后的批量恢复）

如果数据库被删除，但服务器上仍有记录（如您提供的JSON数据），可以：

#### 步骤1：从服务器获取已同步的活动列表

在浏览器中访问：
```
http://localhost:8090/api/synced-activities
```

这会返回所有已同步的活动，例如：
```json
{
  "count": 5,
  "activities": [
    {
      "id": 5,
      "title": "发布公告",
      "description": "1\t",
      "category": "1",
      "organizer": "admin",
      "start_time": "2026-01-04T16:08:51",
      "end_time": "2026-01-05T16:08:51",
      "max_participants": 50,
      "location": "1",
      "status": 1,
      "synced_at": "2026-01-04T08:09:15.200Z"
    },
    ...
  ]
}
```

#### 步骤2：在本地数据库中重新创建活动

1. 打开应用程序
2. 以管理员身份登录
3. 使用"发布活动"功能，根据服务器上的数据重新创建活动
4. 批准活动后，系统会自动同步

或者，如果您有数据库访问权限，可以直接在数据库中插入记录：

```sql
INSERT INTO activities (id, title, description, category, organizer, start_time, end_time, max_participants, location, status, checkin_code)
VALUES (5, '发布公告', '1\t', '1', 'admin', '2026-01-04 16:08:51', '2026-01-05 16:08:51', 50, '1', 1, '');
```

#### 步骤3：手动同步到服务器

创建并批准活动后，使用"手动同步"按钮同步到服务器。

### 方法3：使用API直接同步（不通过数据库）

如果需要直接将JSON数据同步到服务器（不经过本地数据库），可以使用以下方法：

#### 使用PowerShell（Windows）

```powershell
# 同步单个活动
$activity = @{
    id = 5
    title = "发布公告"
    description = "1`t"
    category = "1"
    organizer = "admin"
    start_time = "2026-01-04T16:08:51"
    end_time = "2026-01-05T16:08:51"
    max_participants = 50
    location = "1"
    status = 1
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8090/api/activities/sync" `
    -Method POST `
    -ContentType "application/json" `
    -Body $activity
```

#### 使用curl（Linux/Mac）

```bash
curl -X POST http://localhost:8090/api/activities/sync \
  -H "Content-Type: application/json" \
  -d '{
    "id": 5,
    "title": "发布公告",
    "description": "1\t",
    "category": "1",
    "organizer": "admin",
    "start_time": "2026-01-04T16:08:51",
    "end_time": "2026-01-05T16:08:51",
    "max_participants": 50,
    "location": "1",
    "status": 1
  }'
```

#### 使用浏览器控制台（JavaScript）

```javascript
// 同步单个活动
fetch('http://localhost:8090/api/activities/sync', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        id: 5,
        title: "发布公告",
        description: "1\t",
        category: "1",
        organizer: "admin",
        start_time: "2026-01-04T16:08:51",
        end_time: "2026-01-05T16:08:51",
        max_participants: 50,
        location: "1",
        status: 1
    })
})
.then(res => res.json())
.then(data => {
    console.log('同步结果:', data);
    if (data.success) {
        console.log('✅ 同步成功！');
    } else {
        console.log('❌ 同步失败:', data.message);
    }
})
.catch(error => {
    console.error('❌ 请求失败:', error);
});

// 批量同步多个活动
const activities = [
    {
        id: 5,
        title: "发布公告",
        description: "1\t",
        category: "1",
        organizer: "admin",
        start_time: "2026-01-04T16:08:51",
        end_time: "2026-01-05T16:08:51",
        max_participants: 50,
        location: "1",
        status: 1
    },
    {
        id: 6,
        title: "发布",
        description: "11\t",
        category: "1",
        organizer: "admin",
        start_time: "2026-01-04T16:15:56",
        end_time: "2026-01-05T16:15:56",
        max_participants: 50,
        location: "1",
        status: 1
    }
    // ... 更多活动
];

// 逐个同步
activities.forEach((activity, index) => {
    setTimeout(() => {
        fetch('http://localhost:8090/api/activities/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(activity)
        })
        .then(res => res.json())
        .then(data => {
            console.log(`活动 ${activity.id} (${activity.title}) 同步结果:`, data);
        })
        .catch(error => {
            console.error(`活动 ${activity.id} 同步失败:`, error);
        });
    }, index * 500); // 每个请求间隔500ms，避免过快
});
```

## 注意事项

1. **只能同步已批准的活动**
   - 只有状态为"已批准"的活动才能手动同步
   - 待审批、已拒绝、已结束的活动无法同步

2. **网络连接**
   - 确保服务器正在运行（`http://localhost:8090`）
   - 检查网络连接是否正常

3. **数据格式**
   - 时间格式必须为 ISO 8601 格式：`YYYY-MM-DDTHH:mm:ss`
   - 所有必需字段必须提供：`id`, `title`, `category`, `organizer`, `start_time`, `end_time`

4. **重复同步**
   - 多次同步同一活动不会产生错误
   - 服务器会更新 `synced_at` 时间戳

## 常见问题

### Q1: 为什么"手动同步"按钮是灰色的？

A: 可能的原因：
- 没有选择活动
- 当前用户不是管理员或发起人
- 选中的活动不是"已批准"状态

### Q2: 同步失败怎么办？

A: 检查以下几点：
1. 服务器是否正在运行
2. 网络连接是否正常
3. 活动数据是否完整
4. 查看控制台输出的错误信息

### Q3: 数据库删除后如何恢复？

A: 推荐流程：
1. 从服务器获取已同步的活动列表：`GET /api/synced-activities`
2. 在本地数据库中重新创建这些活动
3. 批准活动后使用"手动同步"功能

### Q4: 可以批量同步吗？

A: 当前界面版本只支持单个活动同步。如需批量同步，可以使用：
- 浏览器控制台的JavaScript代码（见方法3）
- 编写脚本调用API
- 逐个使用界面手动同步

## 技术细节

### 同步API端点

- **URL**: `POST http://localhost:8090/api/activities/sync`
- **Content-Type**: `application/json`
- **请求体格式**:
```json
{
    "id": 5,
    "title": "活动标题",
    "description": "活动描述",
    "category": "活动类别",
    "organizer": "发起人",
    "start_time": "2026-01-04T16:08:51",
    "end_time": "2026-01-05T16:08:51",
    "max_participants": 50,
    "location": "活动地点",
    "status": 1
}
```

### 响应格式

成功：
```json
{
    "success": true,
    "message": "活动同步成功",
    "activity_id": 5
}
```

失败：
```json
{
    "success": false,
    "message": "错误信息"
}
```

## 相关文件

- `activitymanager.cpp` - 活动管理界面实现
- `activitymanager.h` - 活动管理界面头文件
- `networkmanager.cpp` - 网络管理器实现
- `networkmanager.h` - 网络管理器头文件

