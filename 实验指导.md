# 校园活动报名与签到管理系统 - 实验指导

## 实验任务要求

根据实验要求，需要完成一个包含以下模块的校园活动报名与签到管理系统：

- **GUI**: 图形用户界面
- **MV**: Model/View架构
- **DB**: 数据库操作（SQLite）
- **NET**: 网络功能
- **THR**: 多线程
- **FILE**: 文件操作（CSV导出）

## 实验步骤

### 第一步：Qt项目配置

1. **创建Qt项目**
   - 使用Qt Creator创建新的Qt Widgets Application项目
   - 项目名称：`exp_PesernoalWork`

2. **配置.pro文件**
   ```pro
   QT += core gui sql network
   greaterThan(QT_MAJOR_VERSION, 4): QT += widgets
   CONFIG += c++11
   ```
   - 添加 `sql` 模块用于数据库操作
   - 添加 `network` 模块用于网络请求
   - 确保使用C++11标准

### 第二步：数据库设计与实现

#### 2.1 数据库表设计

**用户表 (users)**
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role INTEGER NOT NULL,  -- 0=管理员, 1=发起人, 2=学生
    name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

**活动表 (activities)**
```sql
CREATE TABLE activities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    category TEXT,
    organizer TEXT NOT NULL,
    start_time DATETIME NOT NULL,
    end_time DATETIME NOT NULL,
    max_participants INTEGER NOT NULL,
    current_participants INTEGER DEFAULT 0,
    location TEXT,
    status INTEGER DEFAULT 0,  -- 0=待审批, 1=已批准, 2=已拒绝, 3=进行中, 4=已结束
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    approved_at DATETIME,
    approved_by TEXT
)
```

**报名表 (registrations)**
```sql
CREATE TABLE registrations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    activity_id INTEGER NOT NULL,
    student_id TEXT NOT NULL,
    student_name TEXT NOT NULL,
    status INTEGER DEFAULT 0,
    registered_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    checkin_time DATETIME,  -- 签到时间（新增）
    FOREIGN KEY (activity_id) REFERENCES activities(id) ON DELETE CASCADE,
    UNIQUE(activity_id, student_id)
)
```

**候补表 (waitlist)**
```sql
CREATE TABLE waitlist (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    activity_id INTEGER NOT NULL,
    student_id TEXT NOT NULL,
    student_name TEXT NOT NULL,
    added_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (activity_id) REFERENCES activities(id) ON DELETE CASCADE,
    UNIQUE(activity_id, student_id)
)
```

#### 2.2 数据库操作类实现

创建 `database.h` 和 `database.cpp`，实现：
- 数据库连接和初始化
- 表的创建
- CRUD操作（增删改查）
- 用户认证
- 活动管理
- 报名管理
- 冲突检测
- 签到管理（新增）
- 统计查询

**关键点：**
- 使用 `QSqlDatabase` 连接SQLite数据库
- 使用 `QSqlQuery` 执行SQL语句
- 密码使用SHA256哈希存储
- 使用事务确保数据一致性

### 第三步：用户界面设计

#### 3.1 登录窗口

使用Qt Designer设计登录界面（`loginwindow.ui`）：
- 用户名输入框
- 密码输入框（密码模式）
- 角色选择下拉框
- 登录和注册按钮

**实现要点：**
- 使用 `QDialog` 作为基类
- 实现用户认证逻辑
- 支持新用户注册（学生和发起人）
- 管理员账户只能由系统创建

#### 3.2 主窗口

主窗口（`mainwindow`）包含：
- 菜单栏（文件、网络、帮助）
- 标签页（活动管理、报名管理）
- 状态栏
- 用户信息显示

#### 3.3 活动管理界面

活动管理模块（`ActivityManager`）：
- 活动列表表格（使用 `QTableWidget`）
- 搜索功能
- 发布活动对话框（发起人）
- 审批按钮（管理员）
- 活动详情查看

**Model/View实现：**
- 使用 `QTableWidget` 显示活动列表
- 可以进一步优化为使用 `QTableView` + `QSqlTableModel`

#### 3.4 报名管理界面

报名管理模块（`RegistrationManager`）：
- 学生：显示自己的报名列表、签到功能
- 发起人/管理员：选择活动后显示报名列表、签到管理
- 报名/取消报名功能
- 候补列表查看
- 签到功能（新增）
- 签到列表查看（新增）
- 签到统计（新增）
- CSV导出功能

### 第四步：核心功能实现

#### 4.1 活动发布与审批

**发布活动（发起人）：**
1. 填写活动信息表单
2. 验证输入（标题、类别必填，时间逻辑正确）
3. 调用 `Database::createActivity()` 创建活动
4. 活动状态设为"待审批"

**审批活动（管理员）：**
1. 在活动列表中选择待审批活动
2. 点击"批准"或"拒绝"
3. 调用 `Database::updateActivityStatus()` 更新状态
4. 刷新活动列表

#### 4.2 报名与取消

**报名流程：**
1. 学生输入活动ID
2. 检查活动是否存在且已批准
3. 检查是否已报名
4. 检查时间冲突（调用 `Database::checkTimeConflict()`）
5. 如果活动未满，直接报名；否则加入候补
6. 更新活动参与人数

**取消报名：**
1. 从报名表中删除记录
2. 减少活动参与人数
3. 从候补列表中提升第一个学生

#### 4.3 冲突检测

**时间冲突检测算法：**
```cpp
// 检查两个时间段是否重叠
bool isTimeConflict(DateTime start1, DateTime end1, DateTime start2, DateTime end2) {
    return (start1 <= start2 && end1 > start2) ||  // 开始时间在范围内
           (start1 < end2 && end1 >= end2) ||        // 结束时间在范围内
           (start1 >= start2 && end1 <= end2);       // 完全包含
}
```

**实现：**
- 在 `Database::checkTimeConflict()` 中使用SQL查询
- 查询学生已报名的活动，检查时间是否重叠

#### 4.4 候补排队

**机制：**
1. 当活动报名人数达到上限时，新报名自动加入候补表
2. 候补表按加入时间排序（FIFO）
3. 当有学生取消报名时，自动从候补表提升第一个学生

**实现：**
- `Database::addToWaitlist()` - 添加到候补
- `Database::promoteFromWaitlist()` - 从候补提升

#### 4.5 签到功能（新增）

**签到机制：**
1. 活动开始后，学生可以对自己已报名的活动进行签到
2. 管理员/发起人可以为学生签到
3. 系统记录签到时间
4. 支持查看签到列表和签到统计

**实现：**
- `Database::checkIn()` - 执行签到操作
- `Database::isCheckedIn()` - 检查是否已签到
- `Database::getCheckInList()` - 获取签到列表
- `Database::getCheckInStatistics()` - 获取签到统计（包括签到率）

**签到条件：**
- 学生必须已报名该活动
- 活动必须已开始（当前时间 >= 活动开始时间）
- 每个活动每个学生只能签到一次

### 第五步：多线程实现

#### 5.1 冲突检查线程

创建 `ConflictChecker` 类继承 `QThread`：
- 在后台线程中执行冲突检查
- 避免阻塞UI线程
- 通过信号发送检查结果

**使用场景：**
- 在报名时异步检查冲突
- 批量检查多个活动的冲突

#### 5.2 报表导出线程

创建 `ExportThread` 类继承 `QThread`：
- 在后台执行CSV文件写入
- 避免阻塞UI线程，提升用户体验
- 显示导出进度
- 完成后通过信号通知用户

**实现要点：**
```cpp
class ExportThread : public QThread {
    // 设置导出类型（registrations/statistics）
    void setExportType(const QString &type);
    // 设置文件名
    void setFilename(const QString &filename);
    // 设置导出数据
    void setStatisticsData(const QList<QHash<QString, QVariant>> &statistics);
    
signals:
    void exportProgress(int percentage);  // 导出进度
    void exportFinished(bool success, const QString &message);  // 导出完成
    void exportError(const QString &error);  // 导出错误
};
```

**使用场景：**
- 导出大量数据的统计报表时使用多线程
- 避免UI界面冻结
- 提供进度反馈

### 第六步：网络功能实现

#### 6.1 网络管理类

创建 `NetworkManager` 类：
- 使用 `QNetworkAccessManager` 发送HTTP请求
- 处理JSON响应
- 错误处理

#### 6.2 获取活动类别

```cpp
void NetworkManager::fetchActivityCategories() {
    QUrl url(baseUrl + "/categories");
    QNetworkRequest request(url);
    categoriesReply = networkManager->get(request);
}
```

#### 6.3 获取公告

类似地实现公告获取功能。

#### 6.4 同步活动信息到校园平台（新增）

**功能说明：**
- 活动批准后自动同步到校园平台
- 使用POST请求发送活动信息
- 支持同步结果反馈

**实现：**
```cpp
void NetworkManager::syncActivityToPlatform(int activityId, 
                                            const QHash<QString, QVariant> &activityData);
```

**API接口：**
- URL: `POST /api/activities/sync`
- 请求格式: JSON
- 响应格式: JSON（包含success字段）

**注意事项：**
- 处理网络错误（连接失败、超时等）
- 提供默认数据作为后备
- 使用信号通知UI更新
- 活动批准后自动触发同步

### 第七步：文件操作（CSV导出）

#### 7.1 CSV导出类

创建 `CsvExporter` 类：
- 实现CSV格式写入
- 处理特殊字符（逗号、引号、换行符）
- 支持UTF-8编码（添加BOM以支持Excel）

#### 7.2 导出报名名单

```cpp
bool CsvExporter::exportRegistrations(...) {
    // 写入活动信息
    // 写入报名列表
    // 处理CSV格式
}
```

#### 7.3 导出统计报表

导出所有活动的统计信息，包括：
- 活动基本信息
- 报名人数
- 候补人数
- 状态等

### 第八步：Model/View架构优化（可选）

#### 8.1 使用QSqlTableModel

可以进一步优化，使用Qt的Model/View架构：

```cpp
QSqlTableModel *model = new QSqlTableModel(this, db);
model->setTable("activities");
model->select();
QTableView *view = new QTableView();
view->setModel(model);
```

**优势：**
- 自动同步数据库变化
- 支持排序和过滤
- 更符合MVC架构

### 第九步：测试与调试

#### 9.1 功能测试

1. **登录测试**
   - 测试不同角色的登录
   - 测试错误密码处理
   - 测试新用户注册

2. **活动管理测试**
   - 测试活动发布
   - 测试活动审批
   - 测试活动搜索

3. **报名测试**
   - 测试正常报名
   - 测试时间冲突检测
   - 测试候补机制
   - 测试取消报名

4. **导出测试**
   - 测试CSV导出
   - 验证文件格式
   - 测试多线程导出（大数据量）

5. **网络测试**
   - 测试网络请求（需要服务器）
   - 测试错误处理
   - 测试活动同步功能

6. **签到测试**（新增）
   - 测试学生签到
   - 测试管理员为学生签到
   - 测试签到列表查看
   - 测试签到统计
   - 测试重复签到防护

#### 9.2 边界情况测试

- 活动人数上限测试
- 并发报名测试
- 大量数据测试
- 网络异常测试

## 实验报告要求

### 1. 系统设计

- 系统架构图
- 数据库ER图
- 类图
- 功能模块说明

### 2. 关键技术

- Qt框架使用
- SQLite数据库操作
- 多线程编程
- 网络编程
- Model/View架构

### 3. 核心算法

- 时间冲突检测算法
- 候补排队算法
- 密码哈希算法

### 4. 测试结果

- 功能测试用例
- 测试结果截图
- 性能测试数据

### 5. 问题与解决

- 开发过程中遇到的问题
- 解决方案
- 经验总结

## 常见问题

### Q1: 数据库文件在哪里？

A: 数据库文件 `activity_management.db` 会在程序运行目录下自动创建。

### Q2: 如何修改服务器地址？

A: 在 `networkmanager.cpp` 中修改 `baseUrl` 变量。

### Q3: 如何添加新的活动类别？

A: 可以通过网络接口获取，或者在代码中修改默认类别列表。

### Q4: 密码如何重置？

A: 可以直接删除数据库文件，系统会重新创建默认管理员账户。

### Q5: 如何实现签到功能？

A: 系统已实现完整的签到功能：
- 在报名表中添加了 `checkin_time` 字段
- 学生可以在"报名管理"标签页中对自己已报名的活动进行签到
- 管理员/发起人可以在"报名管理"标签页中为学生签到
- 支持查看签到列表和签到统计（包括签到率）

### Q6: 多线程导出如何使用？

A: 系统已实现多线程报表导出：
- 在导出统计报表时自动使用后台线程
- 导出过程中会显示进度
- 导出完成后会显示结果提示
- 不会阻塞UI界面

## 已实现的扩展功能

1. **签到功能** ✅
   - 活动开始后允许学生签到
   - 管理员/发起人为学生签到
   - 签到列表查看
   - 签到统计（包括签到率）

2. **多线程报表导出** ✅
   - 后台线程执行CSV导出
   - 导出进度显示
   - 避免UI阻塞

3. **网络同步功能** ✅
   - 活动批准后自动同步到校园平台
   - 同步结果反馈

## 其他扩展功能建议

2. **消息通知**
   - 报名成功通知
   - 活动提醒
   - 候补转正通知

3. **数据可视化**
   - 活动参与度统计图表
   - 热门活动分析

4. **权限细化**
   - 更细粒度的权限控制
   - 角色权限配置

5. **移动端支持**
   - 开发移动应用
   - 响应式设计

## 参考资料

- Qt官方文档：https://doc.qt.io/
- SQLite文档：https://www.sqlite.org/docs.html
- Qt数据库编程：https://doc.qt.io/qt-5/sql-programming.html
- Qt网络编程：https://doc.qt.io/qt-5/qtnetwork-index.html

