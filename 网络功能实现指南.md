# 网络功能本地实现指南

本指南将帮助您在本地环境中实现和测试Qt应用程序的网络功能。

## 目录

1. [Qt项目配置](#qt项目配置)
2. [创建本地测试服务器](#创建本地测试服务器)
   - [方案一：Python Flask服务器](#方案一python-flask服务器)
   - [方案二：Node.js Express服务器](#方案二nodejs-express服务器)
3. [测试步骤](#测试步骤)
4. [常见问题](#常见问题)

---

## Qt项目配置

### 1. 确保.pro文件包含network模块

检查 `exp_PesernoalWork.pro` 文件，确保包含以下内容：

```pro
QT += core gui sql network
greaterThan(QT_MAJOR_VERSION, 4): QT += widgets
CONFIG += c++11
```

### 2. 网络管理器配置

当前配置在 `networkmanager.h` 中：

```cpp
QString baseUrl = "http://localhost:8080/api";
```

如需修改服务器地址，可以：
- 直接修改 `baseUrl` 变量
- 或添加配置文件支持动态配置

---

## 创建本地测试服务器

### 方案一：Python Flask服务器

#### 安装依赖

```bash
pip install flask flask-cors
```

#### 创建服务器文件

创建 `test_server.py` 文件（见下方完整代码）

#### 启动服务器

```bash
python test_server.py
```

服务器将在 `http://localhost:8080` 启动

---

### 方案二：Node.js Express服务器

#### 安装依赖

```bash
npm init -y
npm install express cors
```

#### 创建服务器文件

创建 `test_server.js` 文件（见下方完整代码）

#### 启动服务器

```bash
node test_server.js
```

服务器将在 `http://localhost:8080` 启动

---

## API端点说明

### 1. 获取活动类别

- **URL**: `GET /api/categories`
- **响应格式**: JSON数组
- **示例响应**:
```json
[
  {"name": "学术讲座"},
  {"name": "文体活动"},
  {"name": "社会实践"},
  {"name": "志愿服务"},
  {"name": "竞赛活动"},
  {"name": "其他"}
]
```

### 2. 获取公告

- **URL**: `GET /api/announcements`
- **响应格式**: JSON数组
- **示例响应**:
```json
[
  {
    "title": "欢迎使用活动管理系统",
    "content": "系统已上线，欢迎使用！",
    "date": "2024-01-01"
  },
  {
    "title": "活动报名提醒",
    "content": "请及时关注活动信息，及时报名。",
    "date": "2024-01-15"
  }
]
```

### 3. 同步活动信息

- **URL**: `POST /api/activities/sync`
- **请求格式**: JSON
- **请求体示例**:
```json
{
  "id": 1,
  "title": "学术讲座：人工智能前沿",
  "description": "介绍人工智能最新发展",
  "category": "学术讲座",
  "organizer": "张三",
  "start_time": "2024-02-01T10:00:00",
  "end_time": "2024-02-01T12:00:00",
  "max_participants": 100,
  "location": "学术报告厅",
  "status": 1
}
```

- **响应格式**: JSON
- **成功响应**:
```json
{
  "success": true,
  "message": "活动同步成功"
}
```

---

## 测试步骤

### 1. 启动测试服务器

选择一种方案启动服务器：
- Python: `python test_server.py`
- Node.js: `node test_server.js`

### 2. 启动Qt应用程序

在Qt Creator中运行项目，或直接运行编译后的可执行文件。

### 3. 测试获取活动类别

1. 登录系统（任意角色）
2. 点击菜单栏 "网络" -> "获取活动类别"
3. 应该看到类别列表对话框

### 4. 测试获取公告

1. 点击菜单栏 "网络" -> "获取公告"
2. 应该看到公告列表对话框

### 5. 测试活动同步

1. 以管理员身份登录
2. 在"活动管理"标签页中批准一个活动
3. 系统会自动尝试同步到服务器
4. 查看同步结果提示

**注意**：如果同步成功但未显示提示对话框，请：
- 查看Qt Creator的"应用程序输出"窗口中的调试信息
- 参考 `同步功能调试指南.md` 进行问题诊断
- 调试输出会显示同步请求、响应和回调的详细信息

### 6. 测试网络错误处理

1. 停止测试服务器
2. 尝试获取类别（应该使用默认类别）
3. 尝试获取公告（应该显示错误信息）
4. 尝试批准活动（同步应该失败，但不影响活动批准）

---

## 常见问题

### Q1: 连接被拒绝错误

**原因**: 测试服务器未启动或端口被占用

**解决方案**:
1. 确认服务器正在运行
2. 检查端口8080是否被其他程序占用
3. 修改服务器端口或修改Qt中的baseUrl

### Q2: CORS跨域错误

**原因**: 浏览器或服务器CORS配置问题

**解决方案**:
- 使用提供的测试服务器代码（已配置CORS）
- 如果是Qt应用程序，通常不会有CORS问题

### Q3: JSON解析失败

**原因**: 服务器返回的JSON格式不正确

**解决方案**:
1. 检查服务器响应格式
2. 使用浏览器或Postman测试API端点
3. 查看Qt应用程序的调试输出

### Q4: 如何修改服务器地址

**方法1**: 直接修改代码
- 编辑 `networkmanager.h` 中的 `baseUrl` 变量

**方法2**: 添加配置文件（需要额外开发）
- 创建配置文件读取baseUrl
- 或添加设置对话框

### Q5: 如何测试HTTPS

1. 生成SSL证书（用于本地测试）
2. 修改服务器代码支持HTTPS
3. 修改Qt中的baseUrl为 `https://localhost:8080/api`
4. 注意：Qt可能需要配置SSL证书验证

---

## 调试技巧

### 1. 查看网络请求

在Qt代码中添加调试输出：

```cpp
void NetworkManager::fetchActivityCategories()
{
    QUrl url(baseUrl + "/categories");
    qDebug() << "Requesting URL:" << url.toString();
    QNetworkRequest request(url);
    // ...
}
```

### 2. 使用浏览器测试API

直接在浏览器中访问：
- `http://localhost:8080/api/categories`
- `http://localhost:8080/api/announcements`

### 3. 使用Postman测试

使用Postman等工具测试POST请求：
- URL: `http://localhost:8080/api/activities/sync`
- Method: POST
- Headers: `Content-Type: application/json`
- Body: JSON格式的活动数据

---

## 下一步

1. 根据实际需求修改API响应格式
2. 添加身份验证（如果需要）
3. 添加数据库存储（如果需要持久化）
4. 部署到生产环境

---

## 相关文件

- `test_server.py` - Python Flask测试服务器
- `test_server.js` - Node.js Express测试服务器
- `networkmanager.h/cpp` - Qt网络管理器实现
- `mainwindow.cpp` - 主窗口网络功能集成

