# 活动同步功能测试步骤

## 测试前准备

### 1. 确认服务器运行
- ✅ 测试服务器已在 `http://localhost:8080` 运行
- ✅ 可以看到服务器日志输出

### 2. 确认Qt应用程序配置
- ✅ 项目已重新编译（包含新的调试输出）
- ✅ Qt Creator的"应用程序输出"窗口已打开

## 测试步骤

### 步骤1：打开调试输出窗口

在Qt Creator中：
1. 点击菜单：**View** -> **Views** -> **Application Output**
2. 或使用快捷键：**Alt+3**
3. 确保输出窗口可见

### 步骤2：以管理员身份登录

1. 启动Qt应用程序
2. 使用管理员账户登录
   - 默认管理员：`admin` / `admin123`（如果已创建）

### 步骤3：批准活动并观察调试输出

1. 进入"活动管理"标签页
2. 选择一个**待审批**的活动（状态为"待审批"）
3. 点击"批准"按钮
4. 在签到码设置对话框中点击"确定"（可以留空）
5. **立即查看"应用程序输出"窗口**

### 步骤4：检查调试输出

在输出窗口中，你应该看到以下信息（按顺序）：

#### 4.1 活动批准阶段
```
[活动批准] 准备同步活动ID: X
```
- 如果看到这个，说明同步功能已触发

#### 4.2 同步请求阶段
```
[同步请求] 活动ID: X
[同步请求] URL: http://localhost:8080/api/activities/sync
[同步请求] 数据: {"id":X,"title":"...",...}
```
- 如果看到这些，说明请求已发送

#### 4.3 同步响应阶段
```
[同步响应] 活动ID: X 响应数据: {"success":true,...}
[同步响应] JSON对象: QJsonObject({...})
[同步结果] 活动ID: X 成功: true
[同步消息]: 活动同步成功
```
- 如果看到这些，说明服务器响应已收到并解析成功

#### 4.4 同步回调阶段
```
[同步回调] 活动ID: X 成功: true
[同步成功] 显示成功提示
```
- 如果看到这些，说明信号已触发，应该显示对话框

## 问题诊断

### 情况1：没有看到任何调试输出

**可能原因**：
- 项目未重新编译
- 输出窗口未打开
- 代码未执行到同步部分

**解决方法**：
1. 重新编译项目：**Build** -> **Rebuild All**
2. 确认输出窗口已打开
3. 检查 `networkManager` 是否为 `nullptr`

### 情况2：看到请求但没看到响应

**可能原因**：
- 网络连接问题
- 服务器未响应
- 请求格式错误

**解决方法**：
1. 检查服务器日志，看是否收到请求
2. 检查网络连接
3. 查看 `[同步错误]` 输出

### 情况3：看到响应但解析失败

**输出示例**：
```
[同步错误] JSON解析失败: ...
[同步错误] 响应内容: ...
```

**可能原因**：
- 服务器返回的JSON格式不正确
- 编码问题

**解决方法**：
1. 查看 `[同步错误] 响应内容:` 后的实际响应
2. 在浏览器中测试API端点
3. 检查服务器代码

### 情况4：看到"成功: true"但没有对话框

**输出示例**：
```
[同步结果] 活动ID: X 成功: true
[同步回调] 活动ID: X 成功: true
[同步成功] 显示成功提示
```

**可能原因**：
- UI线程问题
- 对话框被其他窗口遮挡
- 信号连接问题

**解决方法**：
1. 检查是否有其他对话框打开
2. 尝试最小化其他窗口
3. 查看是否有错误信息

### 情况5：看到"成功: false"

**输出示例**：
```
[同步结果] 活动ID: X 成功: false
[同步回调] 活动ID: X 成功: false
[同步失败] 显示失败提示
```

**可能原因**：
- 服务器返回 `success: false`
- JSON解析失败
- 网络错误

**解决方法**：
1. 查看完整的调试输出
2. 检查服务器日志
3. 查看 `[同步错误]` 信息

## 快速测试脚本

如果你想快速测试API是否正常工作，可以在浏览器控制台运行：

```javascript
// 测试同步API
fetch('http://localhost:8080/api/activities/sync', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        id: 999,
        title: "测试活动",
        description: "这是一个测试活动",
        category: "学术讲座",
        organizer: "测试发起人",
        start_time: "2024-02-01T10:00:00",
        end_time: "2024-02-01T12:00:00",
        max_participants: 100,
        location: "测试地点",
        status: 1
    })
})
.then(res => res.json())
.then(data => {
    console.log('响应:', data);
    if (data.success) {
        console.log('✅ 同步成功！');
    } else {
        console.log('❌ 同步失败:', data.message);
    }
})
.catch(error => {
    console.error('❌ 请求失败:', error);
});
```

## 预期结果

### 成功场景

1. **服务器日志**显示：
   ```
   [同步成功] 活动ID: X, 标题: ...
   ```

2. **Qt输出窗口**显示：
   ```
   [活动批准] 准备同步活动ID: X
   [同步请求] 活动ID: X
   [同步请求] URL: http://localhost:8080/api/activities/sync
   [同步请求] 数据: {...}
   [同步响应] 活动ID: X 响应数据: {"success":true,...}
   [同步结果] 活动ID: X 成功: true
   [同步回调] 活动ID: X 成功: true
   [同步成功] 显示成功提示
   ```

3. **Qt应用程序**显示：
   - 弹出"同步成功"对话框
   - 内容："活动已同步到校园平台！"

### 失败场景

如果同步失败，应该看到：
- "同步失败"对话框
- 或调试输出中的错误信息

## 下一步

1. **执行测试**：按照上述步骤测试
2. **记录输出**：复制完整的调试输出
3. **报告问题**：如果出现问题，请提供：
   - 完整的调试输出
   - 服务器日志
   - 具体在哪一步出现问题

## 常见问题快速检查清单

- [ ] 服务器是否正在运行？
- [ ] Qt应用程序是否已重新编译？
- [ ] 输出窗口是否已打开？
- [ ] 是否以管理员身份登录？
- [ ] 是否选择了待审批的活动？
- [ ] 是否点击了"批准"按钮？
- [ ] 是否看到了任何调试输出？



