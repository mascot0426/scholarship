# 数据库操作说明

## 数据库文件

- **文件名**: `activity_management.db`
- **类型**: SQLite 3
- **位置**: 程序运行目录
- **创建**: 程序首次运行时自动创建

## 数据库连接

### 在Qt中连接SQLite

```cpp
QSqlDatabase db = QSqlDatabase::addDatabase("QSQLITE");
db.setDatabaseName("activity_management.db");
if (!db.open()) {
    qDebug() << "Error: Failed to open database" << db.lastError().text();
}
```

### 注意事项

1. **SQLite驱动**: Qt默认包含SQLite驱动，无需额外安装
2. **数据库路径**: 可以使用绝对路径或相对路径
3. **并发访问**: SQLite支持多读单写，注意事务处理

## 表结构详解

### 1. 用户表 (users)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键 | PRIMARY KEY AUTOINCREMENT |
| username | TEXT | 用户名 | UNIQUE NOT NULL |
| password | TEXT | 密码哈希 | NOT NULL |
| role | INTEGER | 角色 | NOT NULL (0=管理员, 1=发起人, 2=学生) |
| name | TEXT | 姓名 | |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |

**索引**: username (UNIQUE约束自动创建)

**示例数据**:
```sql
INSERT INTO users (username, password, role, name) 
VALUES ('admin', '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', 0, '系统管理员');
```

### 2. 活动表 (activities)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键 | PRIMARY KEY AUTOINCREMENT |
| title | TEXT | 活动标题 | NOT NULL |
| description | TEXT | 活动描述 | |
| category | TEXT | 活动类别 | |
| organizer | TEXT | 发起人 | NOT NULL |
| start_time | DATETIME | 开始时间 | NOT NULL |
| end_time | DATETIME | 结束时间 | NOT NULL |
| max_participants | INTEGER | 最大人数 | NOT NULL |
| current_participants | INTEGER | 当前人数 | DEFAULT 0 |
| location | TEXT | 地点 | |
| status | INTEGER | 状态 | DEFAULT 0 |
| created_at | DATETIME | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| approved_at | DATETIME | 批准时间 | |
| approved_by | TEXT | 批准人 | |

**状态值**:
- 0: 待审批 (Pending)
- 1: 已批准 (Approved)
- 2: 已拒绝 (Rejected)
- 3: 进行中 (Ongoing)
- 4: 已结束 (Finished)

**索引**: 
- status (idx_activities_status)

**示例数据**:
```sql
INSERT INTO activities (title, description, category, organizer, start_time, end_time, max_participants, location, status)
VALUES ('学术讲座：人工智能前沿', '介绍AI最新发展', '学术讲座', 'teacher1', 
        '2024-12-20 14:00:00', '2024-12-20 16:00:00', 100, '学术报告厅', 1);
```

### 3. 报名表 (registrations)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键 | PRIMARY KEY AUTOINCREMENT |
| activity_id | INTEGER | 活动ID | NOT NULL, FOREIGN KEY |
| student_id | TEXT | 学号 | NOT NULL |
| student_name | TEXT | 学生姓名 | NOT NULL |
| status | INTEGER | 报名状态 | DEFAULT 0 |
| registered_at | DATETIME | 报名时间 | DEFAULT CURRENT_TIMESTAMP |

**外键约束**: 
- activity_id REFERENCES activities(id) ON DELETE CASCADE

**唯一约束**: 
- (activity_id, student_id) - 防止重复报名

**状态值**:
- 0: 已报名 (Registered)
- 1: 已取消 (Cancelled)
- 2: 候补 (Waitlisted)
- 3: 已确认 (Confirmed)

**索引**:
- activity_id (idx_registrations_activity)
- student_id (idx_registrations_student)

**示例数据**:
```sql
INSERT INTO registrations (activity_id, student_id, student_name, status)
VALUES (1, '2021001', '张三', 0);
```

### 4. 候补表 (waitlist)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INTEGER | 主键 | PRIMARY KEY AUTOINCREMENT |
| activity_id | INTEGER | 活动ID | NOT NULL, FOREIGN KEY |
| student_id | TEXT | 学号 | NOT NULL |
| student_name | TEXT | 学生姓名 | NOT NULL |
| added_at | DATETIME | 加入时间 | DEFAULT CURRENT_TIMESTAMP |

**外键约束**: 
- activity_id REFERENCES activities(id) ON DELETE CASCADE

**唯一约束**: 
- (activity_id, student_id) - 防止重复加入候补

**索引**:
- activity_id (idx_waitlist_activity)

**示例数据**:
```sql
INSERT INTO waitlist (activity_id, student_id, student_name)
VALUES (1, '2021002', '李四');
```

## 常用SQL查询

### 1. 用户认证

```sql
SELECT password, role, name 
FROM users 
WHERE username = ?
```

### 2. 获取已批准的活动列表

```sql
SELECT * 
FROM activities 
WHERE status = 1 
ORDER BY start_time
```

### 3. 获取活动的报名列表

```sql
SELECT * 
FROM registrations 
WHERE activity_id = ? 
ORDER BY registered_at
```

### 4. 检查学生是否已报名

```sql
SELECT COUNT(*) 
FROM registrations 
WHERE activity_id = ? AND student_id = ?
```

### 5. 时间冲突检测

```sql
SELECT a.id, a.title, a.start_time, a.end_time
FROM activities a
JOIN registrations r ON a.id = r.activity_id
WHERE r.student_id = ?
AND a.status = 1
AND (
    (a.start_time <= ? AND a.end_time > ?) OR
    (a.start_time < ? AND a.end_time >= ?) OR
    (a.start_time >= ? AND a.end_time <= ?)
)
```

### 6. 获取活动统计信息

```sql
SELECT 
    a.id,
    a.title,
    a.category,
    COUNT(DISTINCT r.id) as current_participants,
    COUNT(DISTINCT w.id) as waitlist_count,
    a.max_participants,
    a.status
FROM activities a
LEFT JOIN registrations r ON a.id = r.activity_id
LEFT JOIN waitlist w ON a.id = w.activity_id
WHERE a.id = ?
GROUP BY a.id
```

### 7. 获取学生的所有报名

```sql
SELECT r.*, a.title, a.start_time, a.end_time, a.location
FROM registrations r
JOIN activities a ON r.activity_id = a.id
WHERE r.student_id = ?
ORDER BY a.start_time
```

### 8. 获取候补列表（按时间排序）

```sql
SELECT * 
FROM waitlist 
WHERE activity_id = ? 
ORDER BY added_at
```

## 数据库操作最佳实践

### 1. 使用参数化查询

**正确**:
```cpp
QSqlQuery query;
query.prepare("SELECT * FROM users WHERE username = ?");
query.addBindValue(username);
query.exec();
```

**错误**:
```cpp
QSqlQuery query;
query.exec("SELECT * FROM users WHERE username = '" + username + "'");
// 容易导致SQL注入攻击
```

### 2. 使用事务

```cpp
db.transaction();
try {
    // 执行多个SQL操作
    query1.exec();
    query2.exec();
    db.commit();
} catch (...) {
    db.rollback();
}
```

### 3. 错误处理

```cpp
QSqlQuery query;
if (!query.exec(sql)) {
    qDebug() << "Error:" << query.lastError().text();
    return false;
}
```

### 4. 使用索引优化查询

已创建的索引：
- `idx_registrations_activity`: 加速按活动ID查询报名
- `idx_registrations_student`: 加速按学号查询报名
- `idx_waitlist_activity`: 加速按活动ID查询候补
- `idx_activities_status`: 加速按状态查询活动

### 5. 外键约束

- 确保数据完整性
- 级联删除：删除活动时自动删除相关报名和候补记录

## 数据库维护

### 备份数据库

```bash
# 复制数据库文件
cp activity_management.db activity_management.db.backup
```

### 恢复数据库

```bash
# 恢复备份
cp activity_management.db.backup activity_management.db
```

### 查看数据库内容

可以使用SQLite命令行工具：

```bash
sqlite3 activity_management.db

# 查看所有表
.tables

# 查看表结构
.schema users

# 查询数据
SELECT * FROM users;

# 退出
.quit
```

### 重置数据库

删除数据库文件，程序会在下次运行时重新创建。

## 性能优化建议

1. **索引优化**: 为常用查询字段创建索引
2. **查询优化**: 避免SELECT *，只查询需要的字段
3. **批量操作**: 使用事务批量插入/更新
4. **连接池**: 对于高并发场景，考虑使用连接池
5. **定期清理**: 定期清理已结束活动的旧数据

## 数据迁移

如果需要修改表结构：

1. **方案一**: 删除旧数据库，重新创建（会丢失数据）
2. **方案二**: 编写迁移脚本

示例迁移脚本：
```sql
-- 添加新字段
ALTER TABLE activities ADD COLUMN contact TEXT;

-- 修改字段类型（SQLite不支持，需要重建表）
-- 1. 创建新表
CREATE TABLE activities_new (...);
-- 2. 复制数据
INSERT INTO activities_new SELECT ... FROM activities;
-- 3. 删除旧表
DROP TABLE activities;
-- 4. 重命名新表
ALTER TABLE activities_new RENAME TO activities;
```

## 常见问题

### Q1: 数据库文件被锁定？

A: 检查是否有其他程序正在使用数据库，或者有未关闭的数据库连接。

### Q2: 如何查看数据库文件大小？

A: 使用文件管理器查看，或使用SQLite命令：
```sql
SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size();
```

### Q3: 如何清空所有数据？

A: 删除数据库文件，或执行：
```sql
DELETE FROM registrations;
DELETE FROM waitlist;
DELETE FROM activities;
DELETE FROM users;
```

### Q4: 如何导出数据？

A: 使用SQLite的导出功能：
```bash
sqlite3 activity_management.db .dump > backup.sql
```

### Q5: 数据库损坏怎么办？

A: 尝试修复：
```bash
sqlite3 activity_management.db "PRAGMA integrity_check;"
```
如果无法修复，使用备份恢复。

